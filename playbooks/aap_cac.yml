---
- name: Configure AAP controller via gateway API (no external collections)
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - ../env/aap_target.yml
    - ../controller_config/organizations.yml
    - ../controller_config/teams.yml
    - ../controller_config/users.yml
    - ../controller_config/credentials.yml
    - ../controller_config/projects.yml
    - ../controller_config/inventories.yml
    - ../controller_config/job_templates.yml
    - ../controller_config/workflow_job_templates.yml

  vars:
    api_base: "{{ aap_hostname | regex_replace('/+$', '') }}/api/controller/v2"

  tasks:

    - name: Ensure organizations
      ansible.builtin.uri:
        url: "{{ api_base }}/organizations/"
        method: POST
        status_code: [200, 201, 202, 400]
        body_format: json
        body:
          name: "{{ item.name }}"
          description: "{{ item.description | default('') }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
      loop: "{{ controller_organizations | default([]) }}"

    - name: Ensure teams
      ansible.builtin.uri:
        url: "{{ api_base }}/teams/"
        method: POST
        status_code: [200, 201, 202, 400]
        body_format: json
        body:
          name: "{{ item.name }}"
          description: "{{ item.description | default('') }}"
          organization: "{{ item.organization }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
      loop: "{{ controller_teams | default([]) }}"

    - name: Ensure users
      ansible.builtin.uri:
        url: "{{ api_base }}/users/"
        method: POST
        status_code: [200, 201, 202, 400]
        body_format: json
        body:
          username: "{{ item.username }}"
          email: "{{ item.email }}"
          password: "{{ item.password }}"
          first_name: "{{ item.first_name | default('') }}"
          last_name: "{{ item.last_name | default('') }}"
          is_superuser: "{{ item.is_superuser | default(false) }}"
          is_system_auditor: "{{ item.is_system_auditor | default(false) }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
      loop: "{{ controller_users | default([]) }}"

    - name: Ensure credentials
      ansible.builtin.uri:
        url: "{{ api_base }}/credentials/"
        method: POST
        status_code: [200, 201, 202, 400]
        body_format: json
        body:
          name: "{{ item.name }}"
          description: "{{ item.description | default('') }}"
          organization: "{{ item.organization | default(omit) }}"
          credential_type: "{{ item.credential_type }}"
          inputs: "{{ item.inputs | default({}) }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
      loop: "{{ controller_credentials | default([]) }}"

    - name: Ensure projects
      ansible.builtin.uri:
        url: "{{ api_base }}/projects/"
        method: POST
        status_code: [200, 201, 202, 400]
        body_format: json
        body:
          name: "{{ item.name }}"
          description: "{{ item.description | default('') }}"
          organization: "{{ item.organization }}"
          scm_type: "{{ item.scm_type }}"
          scm_url: "{{ item.scm_url }}"
          scm_branch: "{{ item.scm_branch | default('main') }}"
          scm_update_on_launch: "{{ item.scm_update_on_launch | default(true) }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
      loop: "{{ controller_projects | default([]) }}"

    - name: Ensure inventories
      ansible.builtin.uri:
        url: "{{ api_base }}/inventories/"
        method: POST
        status_code: [200, 201, 202, 400]
        body_format: json
        body:
          name: "{{ item.name }}"
          description: "{{ item.description | default('') }}"
          organization: "{{ item.organization }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
      loop: "{{ controller_inventories | default([]) }}"

    - name: Ensure job templates
      ansible.builtin.uri:
        url: "{{ api_base }}/job_templates/"
        method: POST
        status_code: [200, 201, 202, 400]
        body_format: json
        body:
          name: "{{ item.name }}"
          description: "{{ item.description | default('') }}"
          organization: "{{ item.organization }}"
          inventory: "{{ item.inventory }}"
          project: "{{ item.project }}"
          playbook: "{{ item.playbook }}"
          job_type: "{{ item.job_type | default('run') }}"
          verbosity: "{{ item.verbosity | default(0) }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
      loop: "{{ controller_job_templates | default([]) }}"

    - name: Ensure workflow job templates (shell only)
      ansible.builtin.uri:
        url: "{{ api_base }}/workflow_job_templates/"
        method: POST
        status_code: [200, 201, 202, 400]
        body_format: json
        body:
          name: "{{ item.name }}"
          description: "{{ item.description | default('') }}"
          organization: "{{ item.organization }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
      loop: "{{ controller_workflow_job_templates | default([]) }}"

